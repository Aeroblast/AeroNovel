## 总述

Tag的转换目标是EPUB，也就是说，大多为一种HTML功能的类bbcode化表述。在转换为论坛bbcode/txt时将会有不同程度劣化。具体可以参考相关源码。

总体的设计思路是一行一个段落，空行也会生成空段落，因此编辑txt时比较直观。

而Tag的设计原则是“在单行内结束”，因此不像论坛bbcode可以跨行，所以使用中请注意不要跨行。`#`出现在行首意味着该行不会视作正文，不会多出空行，用于特殊用途，比如`##`注释，`#HTML:`插入代码。

对于以`「『`等开头的行，生成的段落将被标记，用于对齐等用途。默认情况下，一般段落text-indent为2em，而被标记的段落是1.5em，对于大部分字体可达到视觉上对齐。可以通过CSS覆盖drawout类，修改为其他值。

如果Tag说明里含有“必须单独一行”的表述，则这个tag将必须单独一行，并且前后不能有空格，否则不会被转换。

转换工具遇到可疑的```[xxx]```将会产生警告。



## Tags

### 注释

`[note]`注释标记

`[note=注释内容]`注释内容

注释标记将生成一个epub:type为noteref的上角标链接，并且分配id、href，与注释内容对应。注释标记的内容默认为“注”，如果对应注释内容有半角冒号`:`，注释标记内容将是冒号前的部分。比如`[note][note=译注:balabala]`将会生成内容为`[译注]`的角标链接。

注释内容按顺序分配给注释标记，所以写在哪里也没关系。需要注意的是，注释内容tag不应该占一个空行。转换为HTML时，注释内容被统一加在文档的最后aside标签内的注释区域。支持aside的阅读器将自动隐藏。

### 图片相关

`[img]图片名称[/img]`一般图片

`[illu]图片名称[/illu]`插图，必须单独一行

`[imgchar]图片名称[/imgchar]`图片字符

图片内容可以是URL，也可以是单个图片名称。生成HTML时，将会仅取文件名，检查目录中`Images`文件夹是否存在相应图片。如果需要发布到论坛，请额外写web_images.txt，定义文件名和网络图片地址的对应关系。

一般图片 将简单地生成HTML的img标签。

插图 将会生成一个div包裹的img，具体样式可以参考template中的CSS。效果依阅读器而异：Apple Books和MS Edge(UWP)的翻页模式将使图片在一页里居中显示，Apple Books的滚动模式将占用一屏幕的高度，Kindle简单地占用一页没有居中。

图片字符 生成一个1em高的图片，用于将图片显示为字符，所谓的「外字」gaiji。

### 类

`[class=类名]内容[/class]`

可以自己在style.css里定义样式类，该标签单独一行时将生成p标签，否则为span标签。

### 书内链接

`[chapter=章节编号]链接文字[/chapter]`

以章节编号生成链接。

### 对齐规则

`[align=对齐规则]内容[/align]`对齐规则，必须单独一行。合法值为center、right、left。

需要注意的是，该标签与bbcode语法相同，效果有一点不同。Discuz中，该Tag生成块元素后不处理换行，因此会多产生一个换行，转换bbcode功能对此问题有相应的适配。

### 一般样式

以下样式仅做简单的正则替换。

`[title]内容[/title]`一个预设的类

`[ruby=注音]内容[/ruby]`注音

`[pagebreak]`必须单独一行。生成一个pagebreak段落。

`[emphasis]内容[/emphasis]`加重。暂时和加粗一样，保留了单独的class，想改加重的圆点可以自己改

`[b]内容[/b]`加粗

`[s]内容[/s]`删除线

`[i]内容[/i]`斜体

`[color=颜色]内容[/color]`颜色值直接喂给CSS样式color，那边合法就可以

`[size=大小]内容[/size]`单位是em

`[h1]内容[/h1]`到`[h6]内容[/h6]` 简单翻译


## 注释
注释分为行内注释和单行注释。

### 行内注释

和Tag一起正则处理，范围是行内。

`\*注释内容*\`

`\\\注释内容`直到行尾都是注释内容，前面的不影响。

### 单行注释

`##注释内容`

该行将跳过处理。必须出现在行首。

需要注意的是，`\\\注释内容`和`##注释内容`看起来类似，实际上不一样。如果该行只有`\\\注释内容`，则该行会最终变成`<p><br/></p>`，而`##注释内容`不会产生任何代码。

## 特殊行

特殊行以行的开头区分。单行注释就是一个特殊行。

`#HTML:内容`冒号后面是HTML代码，将会被原封不动地加入生成的文档。请小心使用。典型的用法：加入div包裹一大段需要特殊样式的段落，然后用CSS的子选择或后代选择进行定义。