<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <link rel="stylesheet" href="lib/codemirror.css">
  <link rel="stylesheet" href="theme/3024-day.css">
  <link rel="stylesheet" href="theme/darcula.css">
  <title>AeroNovel-Lite</title>
  <style>
    .tab {
      display: inline-block;
      width: 30vw;
      vertical-align: text-top;
      min-height: 100vh;
    }

    #output_render {
      border: black solid 1px;
    }

    textarea {
      width: 100%;
      min-height: 90vh;
    }

    .CodeMirror {
      height: 90vh;
    }

    .CodeMirror-wrap pre {
      word-break: break-word;
    }
  </style>
</head>

<body>
  <header>
    âœ…åœ¨è¿™ä¸ªé¡µé¢ï¼Œæ‚¨å¯ä»¥ä½“éªŒAeroNovelå¤§è‡´åŠŸèƒ½ã€‚<br>
    âš ï¸æ­¤é¡µé¢çš„æ•ˆæœä¸å‘½ä»¤è¡Œå·¥å…·ä¸å®Œå…¨ç›¸åŒã€‚ä¸åŒ…å«æ‹†ç”Ÿè‚‰EPUBã€ç”ŸæˆEPUBç­‰åŠŸèƒ½<br>
    âš ï¸æ­¤é¡µé¢ä»…ä¾›ä½“éªŒï¼Œä¸åŒ…å«ä»»ä½•ä¼˜åŒ–ï¼Œä¸ä¿è¯æ–‡ç« ç‰¹åˆ«é•¿çš„æ—¶å€™ä¸å¡é¡¿ã€‚<br>
    âœ…æœ‰éœ€è¦å¯ä»¥æ‹¿å»æ”¹ã€‚<br>
    ğŸ‘‰<a target="_blank" href="https://github.com/Aeroblast/AeroNovel">é¡¹ç›®åœ°å€</a>
  </header>
  <div id="container_src" class="tab">

    Select a theme:
    <select onchange="selectTheme()" id="theme_select">
      <option>default</option>
      <option>3024-day</option>
      <option selected>darcula</option>
    </select>
    <textarea id="src">
##AeroNovelToolã‚’ä½¿ã£ã¦EPUBã‚’ã“ã†ã„ã†ãƒ†ã‚¯ã‚¹ãƒˆã«å¤‰æ›ã§ãã¾ã™ã€‚|å¤‰(ã¸ã‚“)æ›(ã‹ã‚“)
å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æŠŠç”Ÿè‚‰EPUBè½¬æ¢ä¸ºè¿™æ ·çš„æ–‡æœ¬ã€‚
##â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
##ç”Ÿã‚‚ã®ã€‚
çƒ¤å¥½çš„ã€‚
##â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
##ç”Ÿã‚‚ã®ã€‚
çƒ¤å¥½çš„ã€‚
##â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
## ãƒ†ã‚¹ãƒˆ
ç¬¬ä¸€è¡Œæ–‡å­—ã€‚
##â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ä¸€èˆ¬çš„txtä¹Ÿå¯ä»¥ç”¨ã€‚
##è¿™æ ·çš„è¡Œä¸ä¼šè¾“å‡ºï¼Œæœ¬è´¨æ˜¯æ³¨é‡Šï¼Œå¯ä»¥ä¸è¦ã€‚
é•¿ä¸€ç‚¹çš„æ–‡å­—å–”å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å™¢å™¢å™¢å™¢å•Šå•Šå•Šå—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯å•¦å•¦å•¦å•¦å•¦å•Šå•Šå•Šå•Šã€‚
è¡Œå†…æ ·å¼ç³»åˆ—ï¼š[ruby=Test]æµ‹è¯•[/ruby]è¿™æ˜¯[b]æµ‹è¯•[/b][s]æµ‹è¯•[/s][color=#ff0000]æµ‹è¯•[/color]ã€‚
#title:æ ‡é¢˜
#center:å±…ä¸­
#center:[size=1.2]ç»„åˆä½¿ç”¨æµ‹è¯•ï¼ˆå•ä½æ˜¯[b]em[/b]ï¼‰[/size]
<div style="line-height:2">
divä¸ä¼šè§¦å‘å¢åŠ pæ ‡ç­¾ï¼Œå¯ä»¥åŠ æ ·å¼ï¼ˆæ­¤åŠŸèƒ½ä¸å‘½ä»¤è¡Œç‰ˆä¸åŒï¼‰
## ãƒ†ã‚¹ãƒˆ
é•¿ä¸€ç‚¹çš„æ–‡å­—å–”å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å“¦å™¢å™¢å™¢å™¢å•Šå•Šå•Šå—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯å•¦å•¦å•¦å•¦å•¦å•Šå•Šå•Šå•Šå•Š
ä¸€äº›æ–‡å­—
ã€Œå¯¹è¯ç¼©è¿›è°ƒæ•´ã€
ã€å¯¹è¯ç¼©è¿›è°ƒæ•´ã€
å¯¹æ¯”
</div>
å¯¹æ¯”ä¸€ä¸‹line-heightæ•ˆæœå§å•Šå•Š
å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Š
å•Šå•Šå•Šå•Šå•Šå•Šå•Šå—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯å—¯
#right:å³å¯¹é½
#left:æ’å›¾æä¾›å±…ä¸­å’Œè‡ªé€‚åº”ï¼š
#illu:https://aeroblast.github.io/AeroNovel/Lite/test_illu.jpg
ç©ºè¡Œæ•°é‡æµ‹è¯•ï¼š

1è¡Œâ†‘


2è¡Œâ†‘</textarea>
  </div>
  <div class="tab">è¾“å‡ºHTMLï¼š<textarea id="output_html"></textarea></div>
  <div class="tab">é¢„è§ˆï¼š<div id="output_render"></div>
  </div>
  <script src="lib/codemirror.js"></script>
  <script src="mode/simple.js"></script>
  <script>
    // https://codemirror.net/demo/simplemode.html
    CodeMirror.defineSimpleMode("simplemode", {
      // The start state contains the rules that are initially used
      start: [
        {
          regex: /(\[b\].*?\[\/b\])/,
          token: "keyword"
        },
        {
          regex: /(\[s\].*?\[\/s\])/,
          token: "keyword"
        },
        {
          regex: /\[color=(.*?)\](.*?)\[\/color\]/,
          token: "keyword"
        },
        {
          regex: /(\[ruby=.*?\].*?\[\/ruby\])/,
          token: "keyword"
        },
        {
          regex: /^#(right|left|center|illu|title):(.*)/,
          token: "keyword"
        },
        { regex: /##.*/, token: "comment" },
      ],
      comment: [
      ],
      meta: {
        dontIndentStates: ["comment"],
        lineComment: "##"
      }
    });
    const src_textarea = document.getElementById("src")
    var editor = CodeMirror.fromTextArea(src_textarea, {
      lineNumbers: true,
      lineWrapping: true,
      mode: "simplemode"
    });
    editor.on("change", function (cm, change) {
      Update();
    })
    const theme_select = document.getElementById("theme_select");
    function selectTheme() {
      let theme = theme_select.options[theme_select.selectedIndex].textContent;
      editor.setOption("theme", theme);
    }
    selectTheme()

    //doc.replaceSelection(string)
    //doc.getSelection()
    //doc.getValue() 
    const output_html = document.getElementById("output_html");
    const output_render = document.getElementById("output_render");
    function Update() {
      let html = RenderAtxt(editor.getValue());
      output_html.value = html;
      output_render.innerHTML = html;
    }
    Update();

    function RenderAtxt(atxt) {
      const reg = [
        [/\[color=(.*?)\](.*?)\[\/color\]/, "<span style=\"color:$1\">$2</span>"],
        [/\[img\](.*?)\[\/img\]/, "<img src='$1'>"],
        [/\[img=(.*?),(.*?)\](.*?)\[\/img\]/, "<img style='width:$1;height:$2' src='$3'>"],
        [/\[b\](.*?)\[\/b\]/, "<b>$1</b>"],
        [/\[ruby=(.*?)\](.*?)\[\/ruby\]/, "<ruby>$2<rt>$1</rt></ruby>"],
        [/\[s\](.*?)\[\/s\]/, "<s>$1</s>"],
        [/\[size=(.*?)\](.*?)\[\/size\]/, "<span style=\"font-size:$1em\">$2</span>"],
        [/^#left:(.*)/, "<p style='text-align:left;margin:0;'>$1</p>"],
        [/^#center:(.*)/, "<p style='text-align:center;margin:0;'>$1</p>"],
        [/^#right:(.*)/, "<p style='text-align:right;margin:0;'>$1</p>"],
        [/^#title:(.*)/, "<p style='font-size:1.4em;font-weight:bold;text-align:center;margin:0.2em;'>$1</p>"],
        [/^#h([1-6]):(.*)/, "<h$1>$2</h$1>"],
        [/\/\/\/.*/, ""],
        [/^#illu:(.*)/, "<p class='aligned' style='text-align:center'><img src=\"$1\" style='max-width:100%;max-height:90vh'></p>"],
        [/(?<!<span style=\"word-wrap:break-word;word-break:break-all;\">)(?<!â€¦)[â€¦]{3,99}/, "<span style=\"word-wrap:break-word;word-break:break-all;\">$0</span>"],
        [/(?<!<span style=\"word-wrap:break-word;word-break:break-all;\">)(?<!â€”)[â€”]{3,99}/, "<span style=\"word-wrap:break-word;word-break:break-all;\">$0</span>"]
      ];
      const lines = atxt.split('\n');
      let html = "";
      for (const line of lines) {
        if (line.startsWith("##")) continue;
        let renderedLine = line;
        let matched = true;
        while (matched) {
          matched = false;
          for (let i = 0; i < reg.length; i++) {
            let match = reg[i][0].exec(renderedLine);
            if (match != null) {
              let rep = reg[i][1];
              switch (i) {
                default:
                  renderedLine = renderedLine.replace(reg[i][0], rep);
                  break;
              }
              matched = true;
              break;
            }
          }
        }
        if (renderedLine == "") renderedLine = "<br>";
        if (
          //if should add <p></p>
          !((str) => {
            const reg_startswith = [
              /^<div/,
              /^<\/div/,
              /^<p /,
              /^<h[1-6]/,
            ];
            for (let i = 0; i < reg_startswith.length; i++) {
              if (str.match(reg_startswith[i])) {
                return true;
              }
            }
            return false;
          })(renderedLine)
        ) {
          //should add <p></p>
          let pStyle = "margin:0;";
          if (
            //if should drawout
            ((c) => {
              const list = ["ã€Œ", "ã€", "ï¼ˆ"];
              for (const k of list) {
                if (c[0] == k) return true;
              }
              return false;
            })(renderedLine)
          ) {
            //should drawout
            pStyle += "text-indent:1.5em;";
            
          } else {
            pStyle += "text-indent:2em;";
          }
          renderedLine =
            "<p style='" + pStyle + "'>" + renderedLine + "</p>";
        }
        html += renderedLine + "\n";
      }
      return html;
    }
  </script>
</body>

</html>